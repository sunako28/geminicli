# .github/workflows/ga4-analytics-production.yml
name: GA4 Analytics Production

on:
  workflow_dispatch:
    inputs:
      analysis_period:
        description: 'åˆ†æžæœŸé–“'
        required: false
        default: 'yesterday'
        type: choice
        options:
        - 'yesterday'
        - '7daysAgo'
        - '30daysAgo'
      analysis_type:
        description: 'åˆ†æžã‚¿ã‚¤ãƒ—'
        required: false
        default: 'comprehensive'
        type: choice
        options:
        - 'basic'
        - 'comprehensive'
        - 'performance'
        - 'traffic'
  schedule:
    # æ¯Žæ—¥åˆå‰10æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 1 * * *'
  issue_comment:
    types: [created]

jobs:
  ga4-web-analysis:
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@gemini analytics'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install GA4 Dependencies
        run: |
          npm install @google-analytics/data@^4.0.0
          npm install googleapis@^128.0.0
          echo "GA4 dependencies installed successfully"
          
      - name: Verify GA4 Setup
        run: |
          echo "=== GA4 Setup Verification ==="
          echo "Property ID exists: ${{ secrets.GA_PROPERTY_ID != '' }}"
          echo "Credentials exist: ${{ secrets.GA_CREDENTIALS != '' }}"
          
          # åŸºæœ¬çš„ãªæŽ¥ç¶šãƒ†ã‚¹ãƒˆ
          cat > test-ga4-connection.js << 'EOF'
          const { BetaAnalyticsDataClient } = require('@google-analytics/data');
          
          async function testConnection() {
            try {
              const credentials = JSON.parse(process.env.GOOGLE_ANALYTICS_CREDENTIALS);
              const client = new BetaAnalyticsDataClient({ credentials });
              
              console.log('âœ… GA4 Client created successfully');
              console.log('ðŸ“Š Property ID:', process.env.GOOGLE_ANALYTICS_PROPERTY_ID);
              console.log('ðŸ”‘ Project ID:', credentials.project_id);
              
              // Simple test query
              const [response] = await client.runReport({
                property: `properties/${process.env.GOOGLE_ANALYTICS_PROPERTY_ID}`,
                dateRanges: [{ startDate: 'yesterday', endDate: 'yesterday' }],
                metrics: [{ name: 'activeUsers' }]
              });
              
              console.log('âœ… Test query successful');
              console.log('ðŸ“ˆ Data rows returned:', response.rowCount || 0);
              
            } catch (error) {
              console.error('âŒ GA4 connection failed:', error.message);
              process.exit(1);
            }
          }
          
          testConnection();
          EOF
          
          node test-ga4-connection.js
        env:
          GOOGLE_ANALYTICS_PROPERTY_ID: ${{ secrets.GA_PROPERTY_ID }}
          GOOGLE_ANALYTICS_CREDENTIALS: ${{ secrets.GA_CREDENTIALS }}
          
      - name: Generate GA4 Analysis Report
        uses: google-gemini/gemini-cli-action@main
        env:
          GH_TOKEN: ${{ github.token }}
        with:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            ## GA4 Webåˆ†æžãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
            
            Google Analytics 4ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ã€åŒ…æ‹¬çš„ãªWebåˆ†æžãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
            
            ### ðŸ“Š åˆ†æžãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
            - **åˆ†æžæœŸé–“**: ${{ github.event.inputs.analysis_period || 'yesterday' }}
            - **åˆ†æžã‚¿ã‚¤ãƒ—**: ${{ github.event.inputs.analysis_type || 'comprehensive' }}
            - **å®Ÿè¡Œæ™‚åˆ»**: ${{ github.run_started_at }}
            - **ãƒˆãƒªã‚¬ãƒ¼**: ${{ github.event_name }}
            
            ### ðŸ”§ åˆ©ç”¨å¯èƒ½ãªGA4ãƒ‡ãƒ¼ã‚¿
            GA4æŽ¥ç¶šãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ãŸã®ã§ã€ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—å¯èƒ½ã§ã™ï¼š
            - ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼æ•°
            - ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
            - ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±
            - ãƒ‡ãƒã‚¤ã‚¹åˆ¥ãƒ‡ãƒ¼ã‚¿
            - æµå…¥çµŒè·¯ãƒ‡ãƒ¼ã‚¿
            - åœ°åŸŸåˆ¥ãƒ‡ãƒ¼ã‚¿
            
            ### ðŸ“‹ ãƒ¬ãƒãƒ¼ãƒˆä½œæˆæŒ‡ç¤º
            
            ä»¥ä¸‹ã®ã‚³ãƒžãƒ³ãƒ‰ã§Issueã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š
            
            ```bash
            gh issue create \
              --title "ðŸ“Š GA4åˆ†æžãƒ¬ãƒãƒ¼ãƒˆ - $(date '+%Y-%m-%d %H:%M')" \
              --body "# ðŸ“Š Google Analytics 4 Webåˆ†æžãƒ¬ãƒãƒ¼ãƒˆ
            
            ## ðŸŽ¯ åˆ†æžæ¦‚è¦
            - **åˆ†æžæœŸé–“**: ${{ github.event.inputs.analysis_period || 'yesterday' }}
            - **åˆ†æžã‚¿ã‚¤ãƒ—**: ${{ github.event.inputs.analysis_type || 'comprehensive' }}
            - **å®Ÿè¡Œæ™‚åˆ»**: ${{ github.run_started_at }}
            - **ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹**: Google Analytics 4
            
            ## ðŸ“ˆ ä¸»è¦æŒ‡æ¨™
            
            ### åŸºæœ¬ãƒ¡ãƒˆãƒªã‚¯ã‚¹
            | æŒ‡æ¨™ | å€¤ | å‰æ—¥æ¯” | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
            |------|----|----|--------|
            | ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼ | [å–å¾—ãƒ‡ãƒ¼ã‚¿] | [å¤‰åŒ–çŽ‡] | [è©•ä¾¡] |
            | ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ | [å–å¾—ãƒ‡ãƒ¼ã‚¿] | [å¤‰åŒ–çŽ‡] | [è©•ä¾¡] |
            | ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•° | [å–å¾—ãƒ‡ãƒ¼ã‚¿] | [å¤‰åŒ–çŽ‡] | [è©•ä¾¡] |
            | ç›´å¸°çŽ‡ | [å–å¾—ãƒ‡ãƒ¼ã‚¿] | [å¤‰åŒ–çŽ‡] | [è©•ä¾¡] |
            | å¹³å‡ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“ | [å–å¾—ãƒ‡ãƒ¼ã‚¿] | [å¤‰åŒ–çŽ‡] | [è©•ä¾¡] |
            
            ## ðŸ“± ãƒ‡ãƒã‚¤ã‚¹åˆ¥åˆ†æž
            
            | ãƒ‡ãƒã‚¤ã‚¹ | ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•° | ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•° | ç›´å¸°çŽ‡ |
            |---------|-----------|------------|--------|
            | ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ— | [ãƒ‡ãƒ¼ã‚¿] | [ãƒ‡ãƒ¼ã‚¿] | [ãƒ‡ãƒ¼ã‚¿] |
            | ãƒ¢ãƒã‚¤ãƒ« | [ãƒ‡ãƒ¼ã‚¿] | [ãƒ‡ãƒ¼ã‚¿] | [ãƒ‡ãƒ¼ã‚¿] |
            | ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ | [ãƒ‡ãƒ¼ã‚¿] | [ãƒ‡ãƒ¼ã‚¿] | [ãƒ‡ãƒ¼ã‚¿] |
            
            ### ðŸ“Š ãƒ‡ãƒã‚¤ã‚¹åˆ¥ã‚¤ãƒ³ã‚µã‚¤ãƒˆ
            - **ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–**: [è©•ä¾¡ã¨ææ¡ˆ]
            - **ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ä½“é¨“**: [è©•ä¾¡ã¨ææ¡ˆ]
            - **ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ**: [è©•ä¾¡ã¨ææ¡ˆ]
            
            ## ðŸŒ æµå…¥çµŒè·¯åˆ†æž
            
            | ãƒãƒ£ãƒãƒ« | ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•° | æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ | ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ |
            |---------|------------|------------|--------------|
            | ã‚ªãƒ¼ã‚¬ãƒ‹ãƒƒã‚¯æ¤œç´¢ | [ãƒ‡ãƒ¼ã‚¿] | [ãƒ‡ãƒ¼ã‚¿] | [ãƒ‡ãƒ¼ã‚¿] |
            | ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ | [ãƒ‡ãƒ¼ã‚¿] | [ãƒ‡ãƒ¼ã‚¿] | [ãƒ‡ãƒ¼ã‚¿] |
            | ã‚½ãƒ¼ã‚·ãƒ£ãƒ« | [ãƒ‡ãƒ¼ã‚¿] | [ãƒ‡ãƒ¼ã‚¿] | [ãƒ‡ãƒ¼ã‚¿] |
            | ãƒªãƒ•ã‚¡ãƒ©ãƒ« | [ãƒ‡ãƒ¼ã‚¿] | [ãƒ‡ãƒ¼ã‚¿] | [ãƒ‡ãƒ¼ã‚¿] |
            | æœ‰æ–™æ¤œç´¢ | [ãƒ‡ãƒ¼ã‚¿] | [ãƒ‡ãƒ¼ã‚¿] | [ãƒ‡ãƒ¼ã‚¿] |
            
            ### ðŸŽ¯ æµå…¥çµŒè·¯ã‚¤ãƒ³ã‚µã‚¤ãƒˆ
            - **æœ€ã‚‚åŠ¹æžœçš„ãªãƒãƒ£ãƒãƒ«**: [åˆ†æžçµæžœ]
            - **æˆé•·æ©Ÿä¼š**: [å…·ä½“çš„ãªææ¡ˆ]
            - **æ”¹å–„ãŒå¿…è¦ãªé ˜åŸŸ**: [å•é¡Œç‚¹ã¨è§£æ±ºç­–]
            
            ## ðŸ“„ äººæ°—ãƒšãƒ¼ã‚¸åˆ†æž
            
            | ãƒšãƒ¼ã‚¸ | ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼ | æ»žåœ¨æ™‚é–“ | ç›´å¸°çŽ‡ |
            |--------|-------------|---------|--------|
            | [ãƒšãƒ¼ã‚¸1] | [ãƒ‡ãƒ¼ã‚¿] | [ãƒ‡ãƒ¼ã‚¿] | [ãƒ‡ãƒ¼ã‚¿] |
            | [ãƒšãƒ¼ã‚¸2] | [ãƒ‡ãƒ¼ã‚¿] | [ãƒ‡ãƒ¼ã‚¿] | [ãƒ‡ãƒ¼ã‚¿] |
            | [ãƒšãƒ¼ã‚¸3] | [ãƒ‡ãƒ¼ã‚¿] | [ãƒ‡ãƒ¼ã‚¿] | [ãƒ‡ãƒ¼ã‚¿] |
            
            ## ðŸ—ºï¸ åœ°åŸŸåˆ¥åˆ†æž
            
            | å›½/åœ°åŸŸ | ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•° | ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•° | å¹³å‡ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“ |
            |---------|-----------|------------|------------------|
            | [åœ°åŸŸ1] | [ãƒ‡ãƒ¼ã‚¿] | [ãƒ‡ãƒ¼ã‚¿] | [ãƒ‡ãƒ¼ã‚¿] |
            | [åœ°åŸŸ2] | [ãƒ‡ãƒ¼ã‚¿] | [ãƒ‡ãƒ¼ã‚¿] | [ãƒ‡ãƒ¼ã‚¿] |
            | [åœ°åŸŸ3] | [ãƒ‡ãƒ¼ã‚¿] | [ãƒ‡ãƒ¼ã‚¿] | [ãƒ‡ãƒ¼ã‚¿] |
            
            ## ðŸš¨ è¦æ³¨æ„äº‹é …
            
            ### ðŸ”´ ç·Šæ€¥å¯¾å¿œãŒå¿…è¦
            - [ç·Šæ€¥æ€§ã®é«˜ã„å•é¡Œ]
            
            ### ðŸŸ¡ æ”¹å–„æŽ¨å¥¨
            - [ä¸­æœŸçš„ãªæ”¹å–„é …ç›®]
            
            ### ðŸŸ¢ å¥½èª¿ãªé …ç›®
            - [ç¶™ç¶šã™ã¹ãè‰¯ã„å‚¾å‘]
            
            ## ðŸ’¡ å…·ä½“çš„æ”¹å–„ææ¡ˆ
            
            ### çŸ­æœŸæ”¹å–„ï¼ˆ1é€±é–“ä»¥å†…ï¼‰
            1. **[æ”¹å–„é …ç›®1]**
               - ç¾çŠ¶: [å•é¡Œã®è©³ç´°]
               - ææ¡ˆ: [å…·ä½“çš„ãªè§£æ±ºç­–]
               - æœŸå¾…åŠ¹æžœ: [å®šé‡çš„ãªåŠ¹æžœäºˆæ¸¬]
               - å®Ÿè£…å·¥æ•°: [å¿…è¦æ™‚é–“ã®è¦‹ç©]
            
            2. **[æ”¹å–„é …ç›®2]**
               - ç¾çŠ¶: [å•é¡Œã®è©³ç´°]
               - ææ¡ˆ: [å…·ä½“çš„ãªè§£æ±ºç­–]
               - æœŸå¾…åŠ¹æžœ: [å®šé‡çš„ãªåŠ¹æžœäºˆæ¸¬]
               - å®Ÿè£…å·¥æ•°: [å¿…è¦æ™‚é–“ã®è¦‹ç©]
            
            ### ä¸­é•·æœŸæ”¹å–„ï¼ˆ1ãƒ¶æœˆä»¥å†…ï¼‰
            1. **[æˆ¦ç•¥çš„æ”¹å–„é …ç›®]**
               - èƒŒæ™¯: [æ”¹å–„ã®å¿…è¦æ€§]
               - ææ¡ˆ: [åŒ…æ‹¬çš„ãªã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³]
               - æœŸå¾…åŠ¹æžœ: [ãƒ“ã‚¸ãƒã‚¹ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ]
               - å®Ÿè£…è¨ˆç”»: [æ®µéšŽçš„ãªå®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—]
            
            ## ðŸ“‹ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³
            
            ### ä»Šé€±ã®å„ªå…ˆäº‹é …
            - [ ] [å…·ä½“çš„ãªã‚¿ã‚¹ã‚¯1]
            - [ ] [å…·ä½“çš„ãªã‚¿ã‚¹ã‚¯2]
            - [ ] [å…·ä½“çš„ãªã‚¿ã‚¹ã‚¯3]
            
            ### æ¥æœˆã¾ã§ã®ç›®æ¨™
            - [ ] [ä¸­æœŸç›®æ¨™1]
            - [ ] [ä¸­æœŸç›®æ¨™2]
            
            ## ðŸ“ž æ¬¡å›žåˆ†æžã§ã®ç¢ºèªäº‹é …
            - ä»Šå›žã®æ”¹å–„ææ¡ˆã®åŠ¹æžœæ¸¬å®š
            - æ–°ã—ã„ãƒˆãƒ¬ãƒ³ãƒ‰ã®ç¢ºèª
            - ç«¶åˆä»–ç¤¾ã¨ã®æ¯”è¼ƒåˆ†æž
            
            ## ðŸ¤– è¿½åŠ åˆ†æžã®ä¾é ¼
            ã‚ˆã‚Šè©³ç´°ãªåˆ†æžãŒå¿…è¦ãªå ´åˆï¼š
            - \`@gemini analytics detailed\` - è©³ç´°åˆ†æž
            - \`@gemini analytics funnel\` - ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ•ã‚¡ãƒãƒ«åˆ†æž
            - \`@gemini analytics compare [æœŸé–“]\` - æœŸé–“æ¯”è¼ƒ
            - \`@gemini analytics mobile\` - ãƒ¢ãƒã‚¤ãƒ«ç‰¹åŒ–åˆ†æž
            
            ---
            
            **ðŸ“Š ãƒ‡ãƒ¼ã‚¿å–å¾—çŠ¶æ³**: âœ… GA4æŽ¥ç¶šæˆåŠŸ  
            **ðŸ¤– ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ **: Gemini CLI + GA4 MCP  
            **ðŸ“… æ¬¡å›žè‡ªå‹•å®Ÿè¡Œ**: æ˜Žæ—¥ 10:00 AM (JST)  
            
            *ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯å®Ÿéš›ã®GA4ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™*"
            ```
            
            ### ðŸš¨ é‡è¦ãªæŒ‡ç¤º
            1. ä¸Šè¨˜ã®ã‚³ãƒžãƒ³ãƒ‰ã‚’å¿…ãšå®Ÿè¡Œã—ã¦ãã ã•ã„
            2. [å–å¾—ãƒ‡ãƒ¼ã‚¿] ã®éƒ¨åˆ†ã¯å®Ÿéš›ã®GA4ãƒ‡ãƒ¼ã‚¿ã§ç½®ãæ›ãˆã¦ãã ã•ã„
            3. åˆ†æžçµæžœã¯å…·ä½“çš„ã§å®Ÿè£…å¯èƒ½ãªå†…å®¹ã«ã—ã¦ãã ã•ã„
            4. ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã‚‚ã€ãã®æ—¨ã‚’ãƒ¬ãƒãƒ¼ãƒˆã«å«ã‚ã¦ãã ã•ã„
            
            ### ðŸ”„ å®Ÿè¡Œé–‹å§‹
            ä»Šã™ãGA4ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã€ä¸Šè¨˜ã®Issueã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

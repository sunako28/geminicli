name: GA4 MCP Analysis
on:
  workflow_dispatch:
    inputs:
      date_range:
        description: '分析期間'
        required: false
        default: 'yesterday'
        type: choice
        options:
        - 'yesterday'
        - '7daysAgo'
        - '30daysAgo'
  schedule:
    - cron: '0 1 * * *'  # 毎日日本時間10時（UTC 1時）
  issue_comment:
    types: [created]

jobs:
  ga4-analysis:
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@gemini analyze'))
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      issues: write
      id-token: write
    
    steps:
      - name: Run GA4 MCP Analysis
        uses: google-gemini/gemini-cli-action@main
        env:
          GH_TOKEN: ${{ github.token }}
          GOOGLE_ANALYTICS_PROPERTY_ID: ${{ secrets.GA_PROPERTY_ID }}
          GOOGLE_ANALYTICS_CREDENTIALS: ${{ secrets.GA_CREDENTIALS }}
        with:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          settings_json: |
            {
              "mcpServers": {
                "google-analytics": {
                  "command": "npx",
                  "args": ["-y", "@modelcontextprotocol/server-google-analytics"],
                  "env": {
                    "GOOGLE_ANALYTICS_PROPERTY_ID": "$GOOGLE_ANALYTICS_PROPERTY_ID",
                    "GOOGLE_ANALYTICS_CREDENTIALS": "$GOOGLE_ANALYTICS_CREDENTIALS"
                  }
                }
              },
              "coreTools": [
                "mcp__google-analytics__getPageViews",
                "mcp__google-analytics__getActiveUsers",
                "mcp__google-analytics__getEvents",
                "mcp__google-analytics__getUserBehavior",
                "mcp__google-analytics__runReport"
              ]
            }
          prompt: |
            あなたは GA4 データ分析アシスタントです。

            ## 📊 実行手順

            1. **GA4データを取得してください:**
               - 対象期間: ${{ github.event.inputs.date_range || 'yesterday' }}
               - ページビューデータ（上位10ページ）
               - イベントデータ（上位10イベント）
               - 基本的なユーザー指標

            2. **データを分析して以下を特定してください:**
               - 最も人気のページとPV数
               - 最も発生したイベントと回数
               - 改善が必要な低パフォーマンスエリア
               - 成功している高パフォーマンスエリア

            3. **分析結果をGitHub Issueに投稿してください:**

            ```bash
            gh issue create \
              --title "📊 GA4日次分析レポート - $(date '+%Y-%m-%d')" \
              --body "# 📊 GA4分析レポート

            ## 📅 分析概要
            - **対象期間**: ${{ github.event.inputs.date_range || 'yesterday' }}
            - **分析実行時刻**: $(date '+%Y-%m-%d %H:%M:%S JST')
            - **データソース**: Google Analytics 4 (MCP)

            ## 📈 基本指標

            ### 📊 主要数値
            - **アクティブユーザー**: [実際の数値]
            - **ページビュー**: [実際の数値]
            - **セッション数**: [実際の数値]
            - **平均セッション時間**: [実際の数値]秒

            ## 🏆 人気コンテンツ TOP5

            ### 📄 人気ページ
            1. **[ページ名]** - [PV数] views
            2. **[ページ名]** - [PV数] views
            3. **[ページ名]** - [PV数] views
            4. **[ページ名]** - [PV数] views
            5. **[ページ名]** - [PV数] views

            ### 🎯 主要イベント
            1. **[イベント名]** - [回数] 回
            2. **[イベント名]** - [回数] 回
            3. **[イベント名]** - [回数] 回
            4. **[イベント名]** - [回数] 回
            5. **[イベント名]** - [回数] 回

            ## 💡 改善提案

            ### 🚀 高パフォーマンス（活用推奨）
            - **成功ページ**: [1位のページ名]
              - 💡 **活用案**: 関連コンテンツの作成、内部リンク強化
            - **人気イベント**: [1位のイベント名]
              - 💡 **活用案**: 同様の機能を他ページにも展開

            ### ⚠️ 改善要注意（対策推奨）
            - **低PVページ**: [最下位のページ名]
              - 🔧 **改善案**: タイトル見直し、SEO対策、導線改善
            - **少ないイベント**: [最少のイベント名]
              - 🔧 **改善案**: UI改善、配置変更、ユーザビリティ向上

            ## 📋 今日のアクションプラン

            ### ✅ すぐできる改善（今日中）
            - [ ] 人気ページの関連記事リンク追加
            - [ ] 低PVページのタイトル確認
            - [ ] 重要ボタンの配置確認

            ### 📈 今週の改善項目
            - [ ] SEO対策の実施
            - [ ] ユーザビリティテスト
            - [ ] コンテンツ更新計画

            ## 📊 パフォーマンス評価

            ### PV評価基準
            - 🥇 100+ : 優秀
            - 🥈 50-99 : 良好  
            - 🥉 10-49 : 平均
            - 😐 1-9 : 要改善
            - 😟 0 : 緊急対策

            ### イベント評価基準
            - 🎉 50+ : 高エンゲージメント
            - 👍 20-49 : 良好
            - 🤔 5-19 : 改善余地
            - 😟 0-4 : 要対策

            ## 🤖 次回分析コマンド
            - \`@gemini analyze\` - 今日の分析
            - \`@gemini analyze 7days\` - 週間分析  
            - \`@gemini analyze 30days\` - 月間分析

            ---
            **📊 データ取得**: MCP経由 GA4 API  
            **🔄 次回自動実行**: 明日 10:00 JST  
            **📈 改善目標**: 週次でPV +10%, イベント +15%"
            ```

            ## ⚡ 重要な実行指示

            1. **必ずGA4 MCPサーバーを使用してリアルデータを取得**
            2. **[実際の数値]や[ページ名]は必ず実データで置換**
            3. **データが取得できない場合は、その旨を明記**
            4. **改善提案は具体的で実行可能なものに**
            5. **パフォーマンス評価は実際の数値に基づいて判定**

            今すぐGA4 MCPサーバーからデータを取得し、実用的な分析レポートをIssueに投稿してください！

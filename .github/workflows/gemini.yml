name: GA4 MCP Connection Test
on:
  workflow_dispatch: {}

jobs:
  ga4-mcp-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    
    steps:
      - name: Setup Python for MCP
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install pipx
        run: |
          python -m pip install --user pipx
          python -m pipx ensurepath
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
      - name: Test GA4 MCP Connection
        uses: google-gemini/gemini-cli-action@main
        env:
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.GA_CREDENTIALS }}
        with:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          settings_json: |
            {
              "mcpServers": {
                "analytics-mcp": {
                  "command": "pipx",
                  "args": [
                    "run",
                    "--spec",
                    "git+https://github.com/googleanalytics/google-analytics-mcp.git",
                    "google-analytics-mcp"
                  ],
                  "env": {
                    "GOOGLE_APPLICATION_CREDENTIALS_JSON": "$GOOGLE_APPLICATION_CREDENTIALS_JSON"
                  }
                }
              }
            }
          prompt: |
            ## 🔧 GA4 MCP接続テスト（修正版）

            以下の順序でGA4 MCPサーバーを慎重にテストしてください：

            ### 1. MCPサーバー基本確認
            ```
            まず、analytics-mcp サーバーが応答するかどうか確認してください
            ```

            ### 2. アカウント概要の取得
            ```
            利用可能なGoogle Analyticsアカウントをリストアップしてください
            ```

            ### 3. プロパティ詳細の取得
            ```
            アカウント内で利用可能なGA4プロパティの一覧を取得してください
            ```

            ### 4. 基本レポートの実行
            ```
            最初に見つかったGA4プロパティで、昨日の基本的なデータを取得してください
            ```

            ## 📊 結果レポート

            テスト結果を以下の形式で報告してください：

            ```
            # 🔧 GA4 MCP接続テスト結果（修正版）

            ## ✅ テスト実行状況

            ### 1. MCPサーバー基本確認
            状況: [成功/失敗]
            応答: [サーバーからの応答内容]

            ### 2. アカウント概要取得
            状況: [成功/失敗]
            結果: [取得できたアカウント情報]

            ### 3. プロパティ一覧取得
            状況: [成功/失敗] 
            結果: [取得できたプロパティ情報]

            ### 4. 基本レポート実行
            状況: [成功/失敗]
            結果: [取得できたデータ]

            ## 🎯 総合判定
            [テスト結果の総合評価]

            ## 🔧 推奨される次のステップ
            [成功した場合と失敗した場合の対応策]
            ```

            ## ⚡ 重要な指示

            1. **各ステップで詳細なエラー情報を記録してください**
            2. **レスポンス解析エラーが出た場合は、その詳細を報告してください**
            3. **プロパティIDを事前指定せずに、動的に発見してください**
            4. **失敗した場合も次のステップに進んでください**

            慎重にテストを開始してください！

name: Gemini GA4 Summary

on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 23 * * *'  # 毎日 日本時間08:00（UTC 23:00）

jobs:
  summarize-ga4:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Write ADC JSON to file
        run: |
          # Secretsに保存されたGA_ADC_JSONをそのままファイルに書き出す
          echo '${{ secrets.GA_ADC_JSON }}' > "$HOME/ga-adc.json"
          chmod 600 "$HOME/ga-adc.json"

      - name: Run Gemini GA4 Summary via MCP
        id: ga4
        uses: google-gemini/gemini-cli-action@main
        env:
          GOOGLE_APPLICATION_CREDENTIALS: $HOME/ga-adc.json
          GA_PROPERTY_ID: ${{ secrets.GA_PROPERTY_ID }}
        with:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          settings_json: |
            {
              "mcpServers": {
                "google-analytics": {
                  "command": "npx",
                  "args": ["-y", "mcp-server-google-analytics"],
                  "env": {
                    "GOOGLE_APPLICATION_CREDENTIALS": "$GOOGLE_APPLICATION_CREDENTIALS",
                    "GA_PROPERTY_ID": "$GA_PROPERTY_ID"
                  }
                }
              },
              "coreTools": ["mcp__google-analytics__run_report"]
            }
          prompt: |
            あなたはGA4の要約アシスタントです。
            GA_PROPERTY_ID のプロパティについて、昨日（プロパティのTZ）を対象に
            - 主なトラフィックソース
            - 人気ページ
            - 主なコンバージョンイベント
            を mcp__google-analytics__run_report で取得・要約してください。
            可能なら前日比/先週同曜日比も一言で補足してください。

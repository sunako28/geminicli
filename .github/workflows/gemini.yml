name: GA4 MCP Connection Test
on:
  workflow_dispatch: {}

jobs:
  ga4-mcp-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    
    steps:
      - name: Setup Python for MCP
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install pipx
        run: |
          python -m pip install --user pipx
          python -m pipx ensurepath
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
      - name: Test GA4 MCP Connection
        uses: google-gemini/gemini-cli-action@main
        env:
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.GA_CREDENTIALS }}
        with:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          settings_json: |
            {
              "mcpServers": {
                "analytics-mcp": {
                  "command": "pipx",
                  "args": [
                    "run",
                    "--spec",
                    "git+https://github.com/googleanalytics/google-analytics-mcp.git",
                    "google-analytics-mcp"
                  ],
                  "env": {
                    "GOOGLE_APPLICATION_CREDENTIALS_JSON": "$GOOGLE_APPLICATION_CREDENTIALS_JSON",
                    "GA_PROPERTY_ID": "${{ secrets.GA_PROPERTY_ID }}"
                  }
                }
              },
              "coreTools": [
                "mcp__analytics-mcp__run_report",
                "mcp__analytics-mcp__get_property_details",
                "mcp__analytics-mcp__get_account_summaries"
              ]
            }
          prompt: |
            ## 🔧 GA4 MCP接続テスト

            以下の順序でGA4 MCPサーバーをテストしてください：

            ### 1. MCPサーバー状況確認
            ```
            MCPサーバーの接続状況を教えてください
            ```

            ### 2. 利用可能ツール確認
            ```
            analytics-mcp から利用可能なツールをすべてリストアップしてください
            ```

            ### 3. プロパティ詳細取得テスト
            ```
            mcp__analytics-mcp__get_property_details を使ってプロパティ ${{ secrets.GA_PROPERTY_ID }} の詳細を取得してください
            ```

            ### 4. アカウント概要取得テスト
            ```
            mcp__analytics-mcp__get_account_summaries を使ってアカウント情報を取得してください
            ```

            ### 5. シンプルレポートテスト
            ```
            mcp__analytics-mcp__run_report を使って、プロパティ ${{ secrets.GA_PROPERTY_ID }} の昨日のページビュー数を取得してください
            ```

            ## 📊 結果レポート

            各テストの結果を以下の形式で報告してください：

            ```
            # 🔧 GA4 MCP接続テスト結果

            ## ✅ テスト実行状況

            ### 1. MCPサーバー接続
            状況: [成功/失敗/不明]
            詳細: [接続状況の詳細]

            ### 2. 利用可能ツール
            状況: [成功/失敗]
            ツール数: [確認できた数]
            主要ツール: [主要なツール名]

            ### 3. プロパティ詳細取得
            状況: [成功/失敗]
            プロパティ名: [取得できた場合は名前]
            エラー: [失敗した場合はエラー内容]

            ### 4. アカウント概要取得
            状況: [成功/失敗]
            アカウント数: [取得できた場合は数]
            エラー: [失敗した場合はエラー内容]

            ### 5. レポート実行
            状況: [成功/失敗]
            ページビュー数: [取得できた場合は数値]
            エラー: [失敗した場合はエラー内容]

            ## 🎯 総合判定

            総合結果: [全て成功/部分的成功/接続失敗]

            ## 🔧 次のステップ

            [成功した場合は分析機能追加を提案]
            [失敗した場合は問題箇所と対処法を提案]
            ```

            ## ⚡ 重要な指示

            1. **各テストを順番に実行してください**
            2. **エラーが出ても次のテストに進んでください**
            3. **実際の結果で [成功/失敗] を置き換えてください**
            4. **エラーの詳細情報も必ず含めてください**
            5. **最後に総合的な判定と次のステップを提案してください**

            今すぐテストを開始してください！

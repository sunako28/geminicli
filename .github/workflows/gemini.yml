# .github/workflows/gemini-comment-handler.yml
name: Gemini Comment Handler

on:
  workflow_dispatch:    # ←これが「Run workflow」ボタンを表示させる
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  handle-gemini-comment:
    # 手動実行時は常に実行、コメント時は@geminiで始まる場合のみ実行
    if: github.event_name == 'workflow_dispatch' || startsWith(github.event.comment.body, '@gemini')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Test Gemini Comment Handler
        uses: google-gemini/gemini-cli-action@main
        env:
          GH_TOKEN: ${{ github.token }}
        with:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            ## Geminiコメント機能テスト
            
            実行情報:
            - 実行方法: ${{ github.event_name }}
            - 実行時刻: ${{ github.run_started_at }}
            - リポジトリ: ${{ github.repository }}
            
            以下の内容でテスト結果をGitHub Issueとして作成してください:
            
            **タイトル**: 🤖 Geminiコメント機能動作テスト結果
            
            **内容**:
            ### ✅ 基本動作確認
            - ワークフロー実行: 成功
            - GitHub Actions連携: 正常
            - Issue作成機能: 正常
            
            ### 📝 次のテスト手順
            1. このIssueに以下のコメントを投稿:
               ```
               @gemini こんにちは！コメント反応テストです。
               ```
            2. 数分待って、Geminiからの返信コメントを確認
            3. 返信があれば、コメント反応機能が正常動作
            
            ### 🔧 テスト用コメント例
            - `@gemini このプロジェクトの概要を教えて`
            - `@gemini コード改善提案をして`
            - `@gemini GEMINI.mdの内容を要約して`
            
            ### 📊 実行詳細
            - 実行ID: ${{ github.run_id }}
            - 実行番号: ${{ github.run_number }}
            
            このIssueを今すぐ作成してください。

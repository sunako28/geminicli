name: GA4 Hybrid Analysis (MCP + Direct API)
on:
  workflow_dispatch:
    inputs:
      date_range:
        description: 'åˆ†ææœŸé–“'
        required: false
        default: 'yesterday'
        type: choice
        options:
        - 'yesterday'
        - '7daysAgo'
        - '30daysAgo'
  schedule:
    - cron: '0 1 * * *'  # æ¯æ—¥æ—¥æœ¬æ™‚é–“10æ™‚ï¼ˆUTC 1æ™‚ï¼‰
  issue_comment:
    types: [created]

jobs:
  ga4-hybrid-analysis:
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@gemini analyze'))
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Get GA4 Data (Fallback Method)
        id: get-ga4-data
        run: |
          npm install @google-analytics/data
          
          cat > get-ga4-data.js << 'EOF'
          const { BetaAnalyticsDataClient } = require('@google-analytics/data');
          
          async function getGA4Data() {
            try {
              const credentials = JSON.parse(process.env.GOOGLE_ANALYTICS_CREDENTIALS);
              const client = new BetaAnalyticsDataClient({ credentials });
              const propertyId = process.env.GA_PROPERTY_ID;
              const dateRange = process.env.DATE_RANGE || 'yesterday';
              
              console.log('ğŸ“Š GA4ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹...');
              console.log(`ğŸ¯ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ID: ${propertyId}`);
              console.log(`ğŸ“… å¯¾è±¡æœŸé–“: ${dateRange}`);
              
              // åŸºæœ¬æŒ‡æ¨™å–å¾—
              const [basicReport] = await client.runReport({
                property: `properties/${propertyId}`,
                dateRanges: [{ startDate: dateRange, endDate: dateRange }],
                metrics: [
                  { name: 'activeUsers' },
                  { name: 'sessions' },
                  { name: 'screenPageViews' },
                  { name: 'averageSessionDuration' }
                ]
              });
              
              // ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼å–å¾—
              const [pageReport] = await client.runReport({
                property: `properties/${propertyId}`,
                dateRanges: [{ startDate: dateRange, endDate: dateRange }],
                dimensions: [{ name: 'pagePath' }],
                metrics: [{ name: 'screenPageViews' }],
                orderBys: [{ metric: { metricName: 'screenPageViews' }, desc: true }],
                limit: 10
              });
              
              // ã‚¤ãƒ™ãƒ³ãƒˆå–å¾—
              const [eventReport] = await client.runReport({
                property: `properties/${propertyId}`,
                dateRanges: [{ startDate: dateRange, endDate: dateRange }],
                dimensions: [{ name: 'eventName' }],
                metrics: [{ name: 'eventCount' }],
                orderBys: [{ metric: { metricName: 'eventCount' }, desc: true }],
                limit: 10
              });
              
              // ãƒ‡ãƒ¼ã‚¿æ•´ç†
              const data = {
                date: dateRange,
                timestamp: new Date().toISOString(),
                propertyId: propertyId,
                metrics: {},
                pages: [],
                events: []
              };
              
              // åŸºæœ¬æŒ‡æ¨™
              if (basicReport.rows && basicReport.rows[0]) {
                const row = basicReport.rows[0];
                data.metrics = {
                  activeUsers: parseInt(row.metricValues[0].value) || 0,
                  sessions: parseInt(row.metricValues[1].value) || 0,
                  pageViews: parseInt(row.metricValues[2].value) || 0,
                  avgSessionDuration: Math.round(parseFloat(row.metricValues[3].value)) || 0
                };
              }
              
              // ãƒšãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿
              if (pageReport.rows) {
                data.pages = pageReport.rows.slice(0, 10).map(row => ({
                  path: row.dimensionValues[0].value,
                  views: parseInt(row.metricValues[0].value)
                }));
              }
              
              // ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿
              if (eventReport.rows) {
                data.events = eventReport.rows.slice(0, 10).map(row => ({
                  name: row.dimensionValues[0].value,
                  count: parseInt(row.metricValues[0].value)
                }));
              }
              
              // GitHub Outputå½¢å¼ã§å‡ºåŠ›
              const output = `GA4_DATA<<EOF\n${JSON.stringify(data, null, 2)}\nEOF`;
              require('fs').appendFileSync(process.env.GITHUB_OUTPUT, output);
              
              console.log('âœ… GA4ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†');
              console.log(`ğŸ“ˆ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${data.metrics.activeUsers}`);
              console.log(`ğŸ“„ ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼: ${data.metrics.pageViews}`);
              console.log(`ğŸ¯ ã‚¤ãƒ™ãƒ³ãƒˆç¨®é¡: ${data.events.length}`);
              console.log(`ğŸ“Š äººæ°—ãƒšãƒ¼ã‚¸: ${data.pages.length}`);
              
            } catch (error) {
              console.error('âŒ GA4ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error.message);
              
              // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚åŸºæœ¬æƒ…å ±ã§ç¶™ç¶š
              const errorData = {
                date: process.env.DATE_RANGE || 'yesterday',
                timestamp: new Date().toISOString(),
                propertyId: process.env.GA_PROPERTY_ID,
                error: error.message,
                metrics: { activeUsers: 0, sessions: 0, pageViews: 0, avgSessionDuration: 0 },
                pages: [],
                events: []
              };
              
              const output = `GA4_DATA<<EOF\n${JSON.stringify(errorData, null, 2)}\nEOF`;
              require('fs').appendFileSync(process.env.GITHUB_OUTPUT, output);
            }
          }
          
          getGA4Data();
          EOF
          
          node get-ga4-data.js
        env:
          GA_PROPERTY_ID: ${{ secrets.GA_PROPERTY_ID }}
          GOOGLE_ANALYTICS_CREDENTIALS: ${{ secrets.GA_CREDENTIALS }}
          DATE_RANGE: ${{ github.event.inputs.date_range || 'yesterday' }}
          
      - name: Setup Python for MCP
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install pipx
        run: |
          python -m pip install --user pipx
          python -m pipx ensurepath
          
      - name: Generate Analysis with MCP Assistance
        uses: google-gemini/gemini-cli-action@main
        env:
          GH_TOKEN: ${{ github.token }}
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.GA_CREDENTIALS }}
        with:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          settings_json: |
            {
              "mcpServers": {
                "analytics-mcp": {
                  "command": "pipx",
                  "args": [
                    "run",
                    "--spec",
                    "git+https://github.com/googleanalytics/google-analytics-mcp.git",
                    "google-analytics-mcp"
                  ],
                  "env": {
                    "GOOGLE_APPLICATION_CREDENTIALS_JSON": "$GOOGLE_APPLICATION_CREDENTIALS_JSON"
                  }
                }
              }
            }
          prompt: |
            ã‚ãªãŸã¯GA4ãƒ‡ãƒ¼ã‚¿åˆ†æã®å°‚é–€å®¶ã§ã™ã€‚ä»¥ä¸‹ã®å–å¾—æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦GitHub Issueã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

            ## ğŸ“Š å–å¾—æ¸ˆã¿GA4ãƒ‡ãƒ¼ã‚¿

            ```json
            ${{ steps.get-ga4-data.outputs.GA4_DATA }}
            ```

            ## ğŸ¯ ã‚ãªãŸã®ä»»å‹™

            ä¸Šè¨˜ã®GA4ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã€**å¿…ãšä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ**ã—ã¦GitHub Issueã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š

            ```
            gh issue create --title "ğŸ“Š GA4ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰åˆ†æãƒ¬ãƒãƒ¼ãƒˆ - $(date '+%Y-%m-%d')" --body "# ğŸ“Š GA4åˆ†æãƒ¬ãƒãƒ¼ãƒˆï¼ˆãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ç‰ˆï¼‰

            ## ğŸ“… åˆ†ææ¦‚è¦
            - **å¯¾è±¡æœŸé–“**: ${{ github.event.inputs.date_range || 'yesterday' }}
            - **åˆ†ææ™‚åˆ»**: $(date '+%Y-%m-%d %H:%M JST')
            - **ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ID**: [JSONã‹ã‚‰æŠ½å‡º]
            - **ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹**: GA4 API + MCPè£œåŠ©
            - **å–å¾—æ–¹æ³•**: Direct API (MCPè£œåŠ©ã‚ã‚Š)

            ## ğŸ“ˆ åŸºæœ¬æŒ‡æ¨™

            ### ğŸ“Š ä¸»è¦æ•°å€¤
            [JSONãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å®Ÿéš›ã®æ•°å€¤ã‚’æŠ½å‡ºã—ã¦è¡¨ç¤º]
            - **ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼**: [activeUsers] äºº
            - **ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°**: [sessions] ã‚»ãƒƒã‚·ãƒ§ãƒ³
            - **ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼**: [pageViews] PV
            - **å¹³å‡ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“**: [avgSessionDuration] ç§’

            ## ğŸ† TOP10ãƒ‡ãƒ¼ã‚¿

            ### ğŸ“„ äººæ°—ãƒšãƒ¼ã‚¸
            [JSONã®pagesãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ä½œæˆ]
            1. [path] - [views] views
            2. [path] - [views] views
            (å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã§10ä½ã¾ã§è¡¨ç¤º)

            ### ğŸ¯ ä¸»è¦ã‚¤ãƒ™ãƒ³ãƒˆ
            [JSONã®eventsãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ä½œæˆ]
            1. [name] - [count] å›
            2. [name] - [count] å›
            (å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã§10ä½ã¾ã§è¡¨ç¤º)

            ## ğŸ’¡ ãƒ‡ãƒ¼ã‚¿ãƒ‰ãƒªãƒ–ãƒ³æ”¹å–„ææ¡ˆ

            ### ğŸš€ å³åŠ¹æ€§ã®ã‚ã‚‹æ”¹å–„ï¼ˆä»Šæ—¥ä¸­ï¼‰
            [å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿åˆ†æã«åŸºã¥ã„ã¦]
            - [ ] æœ€äººæ°—ãƒšãƒ¼ã‚¸ã€Œ[1ä½ã®ãƒšãƒ¼ã‚¸]ã€ã®æˆåŠŸè¦å› ã‚’ä»–ãƒšãƒ¼ã‚¸ã«é©ç”¨
            - [ ] ä½PVãƒšãƒ¼ã‚¸ã®å°ç·šæ”¹å–„
            - [ ] ä¸»è¦ã‚¤ãƒ™ãƒ³ãƒˆã€Œ[1ä½ã®ã‚¤ãƒ™ãƒ³ãƒˆ]ã€ã®ç™ºç”Ÿç‡å‘ä¸Šæ–½ç­–

            ### ğŸ“ˆ ä¸­æœŸæ”¹å–„ï¼ˆä»Šé€±ä¸­ï¼‰
            [å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿åˆ†æã«åŸºã¥ã„ã¦]
            - [ ] SEOå¯¾ç­–ã«ã‚ˆã‚‹è‡ªç„¶æµå…¥å¢—åŠ 
            - [ ] ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£æ”¹å–„ã«ã‚ˆã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“å»¶é•·
            - [ ] ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡å‘ä¸Šæ–½ç­–

            ## ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è©•ä¾¡

            ### ç·åˆè©•ä¾¡
            [å®Ÿéš›ã®æ•°å€¤ã«åŸºã¥ã„ã¦è©•ä¾¡]
            - **ãƒ‡ãƒ¼ã‚¿å“è³ª**: [è‰¯å¥½/è¦æ”¹å–„]
            - **ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯**: [å¤šã„/å¹³å‡çš„/å°‘ãªã„]
            - **ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆ**: [é«˜ã„/æ™®é€š/ä½ã„]

            ### æˆåŠŸæŒ‡æ¨™
            - **PVç›®æ¨™**: å‰å›æ¯” +10%
            - **ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“ç›®æ¨™**: +15ç§’
            - **ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿç›®æ¨™**: +20%

            ## ğŸ”§ æŠ€è¡“è©³ç´°

            ### ãƒ‡ãƒ¼ã‚¿å–å¾—æ–¹æ³•
            - **æ–¹æ³•**: GA4 Data API (Direct)
            - **MCPè£œåŠ©**: analytics-mcp (ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ç¢ºèªç”¨)
            - **èªè¨¼**: Service Account
            - **æœŸé–“**: ${{ github.event.inputs.date_range || 'yesterday' }}

            ### å–å¾—ãƒ‡ãƒ¼ã‚¿è©³ç´°
            [ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ãŸå ´åˆã¯ãã®è©³ç´°ã‚‚è¨˜è¼‰]

            ## ğŸ¤– æ¬¡å›åˆ†æã‚³ãƒãƒ³ãƒ‰
            - \`@gemini analyze\` - ä»Šæ—¥ã®åˆ†æ
            - \`@gemini analyze 7days\` - é€±é–“åˆ†æ  
            - \`@gemini analyze 30days\` - æœˆé–“åˆ†æ

            ---
            **ğŸ“Š ãƒ‡ãƒ¼ã‚¿å–å¾—**: $(date '+%Y-%m-%d %H:%M JST')  
            **ğŸ”„ æ¬¡å›è‡ªå‹•å®Ÿè¡Œ**: æ˜æ—¥ 10:00 JST  
            **ğŸ“ˆ æ”¹å–„ç›®æ¨™**: ç¶™ç¶šçš„æˆé•·"
            ```

            ## âš¡ é‡è¦ãªå®Ÿè¡ŒæŒ‡ç¤º

            1. **JSONãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å®Ÿéš›ã®æ•°å€¤ã‚’æŠ½å‡ºã—ã¦è¡¨ç¤ºã—ã¦ãã ã•ã„**
            2. **[activeUsers] [sessions] ãªã©ã‚’å®Ÿéš›ã®æ•°å€¤ã§ç½®æ›ã—ã¦ãã ã•ã„**
            3. **pagesé…åˆ—ã¨eventsé…åˆ—ã‹ã‚‰TOP10ãƒªã‚¹ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„**
            4. **ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ãŸå ´åˆã¯ãã®è©³ç´°ã‚‚è¨˜è¼‰ã—ã¦ãã ã•ã„**
            5. **å¿…ãš gh issue create ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„**
            6. **å®Ÿè¡Œå®Œäº†å¾Œã€ŒIssue #XX ã‚’ä½œæˆã—ã¾ã—ãŸã€ã¨å ±å‘Šã—ã¦ãã ã•ã„**

            **MCPã‚µãƒ¼ãƒãƒ¼ãŒåˆ©ç”¨å¯èƒ½ã§ã‚ã‚Œã°ã€è¿½åŠ ã®æ´å¯Ÿã‚„GA4ã®è¨­å®šæƒ…å ±ã‚‚å–å¾—ã—ã¦ãã ã•ã„ã€‚**

            ä»Šã™ãå®Ÿè¡Œã—ã¦ãã ã•ã„ï¼

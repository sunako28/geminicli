name: GA4 Official MCP Analysis
on:
  workflow_dispatch:
    inputs:
      date_range:
        description: 'åˆ†ææœŸé–“'
        required: false
        default: 'yesterday'
        type: choice
        options:
        - 'yesterday'
        - '7daysAgo'
        - '30daysAgo'
  schedule:
    - cron: '0 1 * * *'  # æ¯æ—¥æ—¥æœ¬æ™‚é–“10æ™‚ï¼ˆUTC 1æ™‚ï¼‰
  issue_comment:
    types: [created]

jobs:
  ga4-official-mcp-analysis:
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@gemini analyze'))
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      issues: write
      id-token: write
    
    steps:
      - name: Setup Python for MCP
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install pipx
        run: |
          python -m pip install --user pipx
          python -m pipx ensurepath
          
      - name: Run GA4 Official MCP Analysis
        uses: google-gemini/gemini-cli-action@main
        env:
          GH_TOKEN: ${{ github.token }}
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.GA_CREDENTIALS }}
        with:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          settings_json: |
            {
              "mcpServers": {
                "analytics-mcp": {
                  "command": "pipx",
                  "args": [
                    "run",
                    "--spec",
                    "git+https://github.com/googleanalytics/google-analytics-mcp.git",
                    "google-analytics-mcp"
                  ],
                  "env": {
                    "GOOGLE_APPLICATION_CREDENTIALS_JSON": "$GOOGLE_APPLICATION_CREDENTIALS_JSON"
                  }
                }
              }
            }
          prompt: |
            ã‚ãªãŸã¯GA4ãƒ‡ãƒ¼ã‚¿åˆ†æã®å°‚é–€å®¶ã§ã™ã€‚Googleå…¬å¼ã®GA4 MCPã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿åˆ†æã‚’è¡Œã„ã¾ã™ã€‚

            ## ğŸ¯ ã‚ãªãŸã®ä»»å‹™

            1. **ã¾ãšåˆ©ç”¨å¯èƒ½ãªæ©Ÿèƒ½ã‚’ç¢ºèªã—ã¦ãã ã•ã„:**
               ```
               what can the analytics-mcp server do?
               ```

            2. **GA4ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®è©³ç´°ã‚’å–å¾—ã—ã¦ãã ã•ã„:**
               ```
               give me details about my Google Analytics properties
               ```

            3. **${{ github.event.inputs.date_range || 'yesterday' }}ã®æœŸé–“ã§ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ãƒ»åˆ†æã—ã¦ãã ã•ã„:**

               **ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ:**
               ```
               run a report for the last ${{ github.event.inputs.date_range || 'yesterday' }} showing page views by page path, ordered by views descending, limit 10
               ```

               **ã‚¤ãƒ™ãƒ³ãƒˆãƒ¬ãƒãƒ¼ãƒˆ:**
               ```
               run a report for the last ${{ github.event.inputs.date_range || 'yesterday' }} showing event count by event name, ordered by count descending, limit 10
               ```

               **ãƒ¦ãƒ¼ã‚¶ãƒ¼åŸºæœ¬æŒ‡æ¨™:**
               ```
               run a report for the last ${{ github.event.inputs.date_range || 'yesterday' }} showing active users, sessions, page views, and average session duration
               ```

            4. **åˆ†æçµæœã‚’GitHub Issueã«æŠ•ç¨¿ã—ã¦ãã ã•ã„:**

            å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’åŸºã«ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’**å¿…ãšå®Ÿè¡Œ**ã—ã¦ãã ã•ã„ï¼š

            ```
            gh issue create --title "ğŸ“Š GA4å…¬å¼MCPåˆ†æãƒ¬ãƒãƒ¼ãƒˆ - $(date '+%Y-%m-%d')" --body "# ğŸ“Š GA4åˆ†æãƒ¬ãƒãƒ¼ãƒˆï¼ˆå…¬å¼MCPç‰ˆï¼‰

            ## ğŸ“… åˆ†ææ¦‚è¦
            - **å¯¾è±¡æœŸé–“**: ${{ github.event.inputs.date_range || 'yesterday' }}
            - **åˆ†ææ™‚åˆ»**: $(date '+%Y-%m-%d %H:%M JST')
            - **ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹**: Google Analytics 4 (å…¬å¼MCP)
            - **MCPã‚µãƒ¼ãƒãƒ¼**: analytics-mcp (Googleå…¬å¼)

            ## ğŸ“ˆ åŸºæœ¬æŒ‡æ¨™

            ### ğŸ“Š ä¸»è¦æ•°å€¤
            [MCPã‹ã‚‰å–å¾—ã—ãŸå®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã§ç½®æ›]
            - **ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼**: [å®Ÿéš›ã®æ•°å€¤] äºº
            - **ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°**: [å®Ÿéš›ã®æ•°å€¤] ã‚»ãƒƒã‚·ãƒ§ãƒ³
            - **ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼**: [å®Ÿéš›ã®æ•°å€¤] PV
            - **å¹³å‡ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“**: [å®Ÿéš›ã®æ•°å€¤] ç§’

            ## ğŸ† TOP10ãƒ‡ãƒ¼ã‚¿

            ### ğŸ“„ äººæ°—ãƒšãƒ¼ã‚¸
            [MCPã‹ã‚‰å–å¾—ã—ãŸå®Ÿéš›ã®ãƒšãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ã§ãƒªã‚¹ãƒˆä½œæˆ]
            1. [ãƒšãƒ¼ã‚¸ãƒ‘ã‚¹] - [PVæ•°] views
            2. [ãƒšãƒ¼ã‚¸ãƒ‘ã‚¹] - [PVæ•°] views
            3. [ãƒšãƒ¼ã‚¸ãƒ‘ã‚¹] - [PVæ•°] views
            (ä»¥ä¸‹ã€å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã§10ä½ã¾ã§)

            ### ğŸ¯ ä¸»è¦ã‚¤ãƒ™ãƒ³ãƒˆ
            [MCPã‹ã‚‰å–å¾—ã—ãŸå®Ÿéš›ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã§ãƒªã‚¹ãƒˆä½œæˆ]
            1. [ã‚¤ãƒ™ãƒ³ãƒˆå] - [å›æ•°] å›
            2. [ã‚¤ãƒ™ãƒ³ãƒˆå] - [å›æ•°] å›
            3. [ã‚¤ãƒ™ãƒ³ãƒˆå] - [å›æ•°] å›
            (ä»¥ä¸‹ã€å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã§10ä½ã¾ã§)

            ## ğŸ’¡ ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãæ”¹å–„ææ¡ˆ

            ### ğŸš€ é«˜ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼ˆæ´»ç”¨æ¨å¥¨ï¼‰
            [å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿åˆ†æã«åŸºã¥ã„ã¦]
            - **æœ€äººæ°—ãƒšãƒ¼ã‚¸**: [1ä½ã®ãƒšãƒ¼ã‚¸]
              - ğŸ’¡ **æ´»ç”¨æ¡ˆ**: ã“ã®ãƒšãƒ¼ã‚¸ã®æˆåŠŸè¦å› ã‚’ä»–ãƒšãƒ¼ã‚¸ã«å¿œç”¨
            - **ä¸»è¦ã‚¤ãƒ™ãƒ³ãƒˆ**: [1ä½ã®ã‚¤ãƒ™ãƒ³ãƒˆ]
              - ğŸ’¡ **æ´»ç”¨æ¡ˆ**: åŒæ§˜ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä¿ƒé€²

            ### âš ï¸ æ”¹å–„æ©Ÿä¼šï¼ˆå¯¾ç­–æ¨å¥¨ï¼‰
            [å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿åˆ†æã«åŸºã¥ã„ã¦]
            - **ä½ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒšãƒ¼ã‚¸**: [ä¸‹ä½ã®ãƒšãƒ¼ã‚¸]
              - ğŸ”§ **æ”¹å–„æ¡ˆ**: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¦‹ç›´ã—ã€SEOå¯¾ç­–
            - **å°‘ãªã„ã‚¤ãƒ™ãƒ³ãƒˆ**: [å°‘ãªã„ã‚¤ãƒ™ãƒ³ãƒˆ]
              - ğŸ”§ **æ”¹å–„æ¡ˆ**: UI/UXæ”¹å–„ã€å°ç·šæœ€é©åŒ–

            ## ğŸ“‹ ä»Šæ—¥ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³

            ### âœ… å³åº§ã«ã§ãã‚‹æ”¹å–„
            - [ ] [å…·ä½“çš„ã§å®Ÿè¡Œå¯èƒ½ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³]
            - [ ] [å…·ä½“çš„ã§å®Ÿè¡Œå¯èƒ½ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³]
            - [ ] [å…·ä½“çš„ã§å®Ÿè¡Œå¯èƒ½ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³]

            ### ğŸ“ˆ ä»Šé€±ã®æ”¹å–„é …ç›®
            - [ ] [ä¸­æœŸçš„ãªæ”¹å–„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³]
            - [ ] [ä¸­æœŸçš„ãªæ”¹å–„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³]

            ## ğŸ“Š ãƒ‡ãƒ¼ã‚¿å“è³ªè©•ä¾¡

            ### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è©•ä¾¡
            [å®Ÿéš›ã®æ•°å€¤ã«åŸºã¥ã„ã¦è©•ä¾¡]
            - **ç·åˆè©•ä¾¡**: [å„ªç§€/è‰¯å¥½/å¹³å‡/è¦æ”¹å–„]
            - **æˆé•·ãƒˆãƒ¬ãƒ³ãƒ‰**: [å¢—åŠ /æ¨ªã°ã„/æ¸›å°‘]
            - **æ³¨ç›®ç‚¹**: [ç‰¹ç­†ã™ã¹ããƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆ]

            ## ğŸ”§ GA4 MCPæ©Ÿèƒ½æ´»ç”¨

            ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯ä»¥ä¸‹ã®Googleå…¬å¼MCPæ©Ÿèƒ½ã‚’ä½¿ç”¨ï¼š
            - **run_report**: æ¨™æº–ãƒ¬ãƒãƒ¼ãƒˆå®Ÿè¡Œ
            - **get_property_details**: ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è©³ç´°å–å¾—
            - **get_account_summaries**: ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ¦‚è¦å–å¾—

            ## ğŸ¤– æ¬¡å›åˆ†æã‚³ãƒãƒ³ãƒ‰
            - \`@gemini analyze\` - ä»Šæ—¥ã®åˆ†æ
            - \`@gemini analyze 7days\` - é€±é–“åˆ†æ  
            - \`@gemini analyze 30days\` - æœˆé–“åˆ†æ

            ---
            **ğŸ“Š ãƒ‡ãƒ¼ã‚¿å–å¾—**: Googleå…¬å¼MCP analytics-mcp  
            **ğŸ”„ æ¬¡å›è‡ªå‹•å®Ÿè¡Œ**: æ˜æ—¥ 10:00 JST  
            **ğŸ“ˆ æ”¹å–„ç›®æ¨™**: ç¶™ç¶šçš„ãªæˆé•·ã‚’ç›®æŒ‡ã™"
            ```

            ## âš¡ é‡è¦ãªå®Ÿè¡ŒæŒ‡ç¤º

            1. **å¿…ãšGoogleå…¬å¼ã®analytics-mcp MCPã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„**
            2. **å®Ÿéš›ã®GA4ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ [å®Ÿéš›ã®æ•°å€¤] [ãƒšãƒ¼ã‚¸ãƒ‘ã‚¹] [ã‚¤ãƒ™ãƒ³ãƒˆå] ã‚’ç½®æ›ã—ã¦ãã ã•ã„**
            3. **ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ããªã„å ´åˆã¯ã€ãã®ç†ç”±ã¨å¯¾å‡¦æ³•ã‚’æ˜è¨˜ã—ã¦ãã ã•ã„**
            4. **åˆ†æã¯å®Ÿãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦å…·ä½“çš„ã§å®Ÿç”¨çš„ã«ã—ã¦ãã ã•ã„**
            5. **å¿…ãš gh issue create ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦GitHub Issueã‚’ä½œæˆã—ã¦ãã ã•ã„**
            6. **å®Ÿè¡Œå®Œäº†å¾Œã€ŒIssue #XX ã‚’ä½œæˆã—ã¾ã—ãŸã€ã¨å ±å‘Šã—ã¦ãã ã•ã„**

            ä»Šã™ãGoogleå…¬å¼GA4 MCPã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ç”¨ã—ã¦åˆ†æã‚’é–‹å§‹ã—ã¦ãã ã•ã„ï¼

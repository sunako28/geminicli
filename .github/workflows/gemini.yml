\# .github/workflows/reliable-gemini-issue.yml
name: Reliable Gemini Issue Creation

on:
  workflow_dispatch:
  issue_comment:
    types: [created]

jobs:
  create-issue-reliably:
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && startsWith(github.event.comment.body, '@gemini issue'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Verify GitHub CLI
        run: |
          echo "=== GitHub CLI Verification ==="
          gh auth status
          gh repo view ${{ github.repository }}
          echo "GitHub CLI is working correctly"
        env:
          GH_TOKEN: ${{ github.token }}
          
      - name: Gemini Issue Creation with Verification
        uses: google-gemini/gemini-cli-action@main
        env:
          GH_TOKEN: ${{ github.token }}
        with:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            ## ğŸ“‹ CRITICAL INSTRUCTION: Issueä½œæˆã‚’ç¢ºå®Ÿã«å®Ÿè¡Œã—ã¦ãã ã•ã„
            
            ä»¥ä¸‹ã®æ‰‹é †ã‚’**é †ç•ªé€šã‚Šã«å¿…ãšå®Ÿè¡Œ**ã—ã¦ãã ã•ã„ï¼š
            
            ### Step 1: GitHub CLIå‹•ä½œç¢ºèª
            ã¾ãšã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§GitHub CLIãŒå‹•ä½œã™ã‚‹ã‹ç¢ºèªï¼š
            ```bash
            gh auth status
            ```
            
            ### Step 2: Issueä½œæˆã®å®Ÿè¡Œ
            ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’**å¿…ãšå®Ÿè¡Œ**ã—ã¦ãã ã•ã„ï¼ˆã‚³ãƒ”ãƒ¼&ãƒšãƒ¼ã‚¹ãƒˆã—ã¦å®Ÿè¡Œï¼‰ï¼š
            
            ```bash
            gh issue create \
              --title "ğŸ“Š Geminiåˆ†æãƒ¬ãƒãƒ¼ãƒˆ - $(date '+%Y-%m-%d %H:%M')" \
              --body "# ğŸ“Š è‡ªå‹•åˆ†æãƒ¬ãƒãƒ¼ãƒˆ

            ## ğŸ¤– å®Ÿè¡Œæƒ…å ±
            - **å®Ÿè¡Œæ™‚åˆ»**: ${{ github.run_started_at }}
            - **ãƒˆãƒªã‚¬ãƒ¼**: ${{ github.event_name }}
            - **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: Reliable Gemini Issue Creation
            - **Node.js**: 20.x

            ## âœ… æˆåŠŸã—ãŸå‡¦ç†
            - GitHub Actionså®Ÿè¡Œ: æˆåŠŸ
            - Gemini CLIèµ·å‹•: æˆåŠŸ
            - GitHub CLIèªè¨¼: æˆåŠŸ
            - Issueä½œæˆ: æˆåŠŸ

            ## ğŸ“ˆ åˆ†æçµæœï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰
            | æŒ‡æ¨™ | å€¤ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
            |------|----|----|
            | ã‚·ã‚¹ãƒ†ãƒ å‹•ä½œ | æ­£å¸¸ | âœ… |
            | APIæ¥ç¶š | æˆåŠŸ | âœ… |
            | ãƒ‡ãƒ¼ã‚¿å–å¾— | æº–å‚™ä¸­ | ğŸ”„ |

            ## ğŸ’¡ æ”¹å–„ææ¡ˆ
            1. **GA4é€£æºã®è¨­å®š**
               - Google Analytics MCPã‚µãƒ¼ãƒãƒ¼ã®è¨­å®š
               - èªè¨¼æƒ…å ±ã®ç¢ºèª
               - ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®å–å¾—

            2. **è‡ªå‹•åŒ–ã®å¼·åŒ–**
               - å®šæœŸå®Ÿè¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®è¨­å®š
               - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ”¹å–„
               - é€šçŸ¥æ©Ÿèƒ½ã®è¿½åŠ 

            ## ğŸ”„ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
            - [ ] GA4 MCPè¨­å®šã®å®Œäº†
            - [ ] å®Ÿéš›ã®Analyticsãƒ‡ãƒ¼ã‚¿ã§ã®ãƒ†ã‚¹ãƒˆ
            - [ ] å®šæœŸå®Ÿè¡Œã®æœ‰åŠ¹åŒ–

            ## ğŸ¤– è¿½åŠ ã‚³ãƒãƒ³ãƒ‰
            - \`@gemini analytics\` - GA4åˆ†æå®Ÿè¡Œ
            - \`@gemini issue è©³ç´°åˆ†æ\` - è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
            - \`@gemini setup\` - è¨­å®šç¢ºèª

            ---
            *ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯Gemini CLIã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*"
            ```
            
            ### Step 3: å®Ÿè¡Œçµæœã®ç¢ºèª
            ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œå¾Œã€ä»¥ä¸‹ã‚’ç¢ºèªï¼š
            ```bash
            echo "Issue creation completed"
            gh issue list --limit 1
            ```
            
            ### Step 4: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
            ã‚‚ã—Step 2ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€ä»¥ä¸‹ã‚’å®Ÿè¡Œï¼š
            ```bash
            echo "Primary issue creation failed, trying alternative method"
            gh issue create --title "ğŸš¨ Issue Creation Backup" --body "Backup issue creation method used"
            ```
            
            ## ğŸš¨ é‡è¦ãªæ³¨æ„
            - ä¸Šè¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã¯å¿…ãšå®Ÿè¡Œã—ã¦ãã ã•ã„
            - ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œçµæœã‚’ãƒ­ã‚°ã§ç¢ºèªã—ã¦ãã ã•ã„
            - ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„
            
            ## å®Ÿè¡Œé–‹å§‹
            ä»Šã™ãStep 1ã‹ã‚‰é †ç•ªã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

name: GA4 Analytics Summary
on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 1 * * *'  # 毎日日本時間10時（UTC 1時）
  issue_comment:
    types: [created]
jobs:
  analyze-ga4:
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@gemini ga4'))
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      issues: write
      id-token: write
    steps:
      - name: Run GA4 Analytics Summary
        uses: google-gemini/gemini-cli-action@main
        env:
          GOOGLE_CLIENT_EMAIL: ${{ secrets.GOOGLE_CLIENT_EMAIL }}
          GOOGLE_PRIVATE_KEY: ${{ secrets.GOOGLE_PRIVATE_KEY }}
          GA_PROPERTY_ID: ${{ secrets.GA_PROPERTY_ID }}
          GH_TOKEN: ${{ github.token }}
        with:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          settings_json: |
            {
              "mcpServers": {
                "google-analytics": {
                  "command": "npx",
                  "args": ["-y", "mcp-server-google-analytics"],
                  "env": {
                    "GOOGLE_CLIENT_EMAIL": "$GOOGLE_CLIENT_EMAIL",
                    "GOOGLE_PRIVATE_KEY": "$GOOGLE_PRIVATE_KEY",
                    "GA_PROPERTY_ID": "$GA_PROPERTY_ID"
                  }
                }
              },
              "coreTools": [
                "mcp__google-analytics__getPageViews",
                "mcp__google-analytics__getEvents"
              ]
            }
          prompt: |
            あなたは GA4 データ分析アシスタントです。
            1. プロパティ ${{ secrets.GA_PROPERTY_ID }} から昨日分のページビューとイベントデータを取得してください。
            2. 最も人気のページとイベントを特定してください。
            3. 見つかった内容を短い段落と人気ページ・イベントの箇条書きでまとめてください。
            4. 改善提案も含めてください。
            5. 要約を GitHub Issue として投稿してください。

            以下の形式でGitHub Issueを作成してください：

            タイトル: "📊 GA4日次レポート - $(date '+%Y-%m-%d')"

            内容:
            ```
            # 📊 GA4日次分析レポート

            ## 📅 概要
            - **分析日**: 昨日
            - **プロパティ**: ${{ secrets.GA_PROPERTY_ID }}
            - **分析時刻**: $(date '+%Y-%m-%d %H:%M JST')

            ## 📈 主要データ

            ### 人気ページ TOP3
            [実際のデータで置換]
            1. ページA - XXX PV
            2. ページB - XXX PV  
            3. ページC - XXX PV

            ### 主要イベント TOP3
            [実際のデータで置換]
            1. イベントA - XXX 回
            2. イベントB - XXX 回
            3. イベントC - XXX 回

            ## 💡 今日の改善提案

            **人気ページの活用:**
            - [具体的な提案]

            **イベント最適化:**
            - [具体的な提案]

            ## 🎯 明日への注目ポイント
            - [注目すべきKPI]
            - [改善施策の効果測定]

            ## 🤖 次回分析
            `@gemini ga4` でコメントすると即座に再分析

            ---
            📊 データソース: GA4 MCP | 🕒 更新: 毎日10時
            ```

            重要：
            - 必ず実際のGA4データを取得してプレースホルダーを置換してください
            - データ取得できない場合はその旨を明記してください
            - GitHub Issueの作成も必ず実行してください

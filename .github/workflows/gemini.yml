# .github/workflows/ga4-events-numbers.yml
name: GA4 Events Numbers Only

on:
  workflow_dispatch:
    inputs:
      date_range:
        description: 'åˆ†ææœŸé–“'
        required: false
        default: 'yesterday'
        type: choice
        options:
        - 'yesterday'
        - '7daysAgo'
        - '30daysAgo'
  schedule:
    # æ¯æ—¥åˆå‰10æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 1 * * *'
  issue_comment:
    types: [created]

jobs:
  ga4-events-numbers:
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@gemini numbers'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install GA4 Dependencies
        run: |
          npm install @google-analytics/data@^4.0.0
          
      - name: Extract GA4 Numbers
        run: |
          echo "=== GA4 æ•°å€¤ãƒ‡ãƒ¼ã‚¿å–å¾— ==="
          
          cat > extract-ga4-numbers.js << 'EOF'
          const { BetaAnalyticsDataClient } = require('@google-analytics/data');
          
          async function extractNumbers() {
            try {
              const credentials = JSON.parse(process.env.GOOGLE_ANALYTICS_CREDENTIALS);
              const client = new BetaAnalyticsDataClient({ credentials });
              const propertyId = process.env.GOOGLE_ANALYTICS_PROPERTY_ID;
              const dateRange = process.env.DATE_RANGE || 'yesterday';
              
              console.log('ğŸ“Š GA4 Data Extraction Started');
              console.log('ğŸ“… Date Range:', dateRange);
              
              // åŸºæœ¬ãƒ¡ãƒˆãƒªã‚¯ã‚¹
              const [basicMetrics] = await client.runReport({
                property: `properties/${propertyId}`,
                dateRanges: [{ startDate: dateRange, endDate: dateRange }],
                metrics: [
                  { name: 'activeUsers' },
                  { name: 'newUsers' },
                  { name: 'sessions' },
                  { name: 'screenPageViews' },
                  { name: 'bounceRate' },
                  { name: 'averageSessionDuration' }
                ]
              });
              
              // ã‚¤ãƒ™ãƒ³ãƒˆåˆ¥ãƒ‡ãƒ¼ã‚¿
              const [eventData] = await client.runReport({
                property: `properties/${propertyId}`,
                dateRanges: [{ startDate: dateRange, endDate: dateRange }],
                dimensions: [{ name: 'eventName' }],
                metrics: [{ name: 'eventCount' }],
                orderBys: [{ metric: { metricName: 'eventCount' }, desc: true }],
                limit: 20
              });
              
              // ãƒšãƒ¼ã‚¸åˆ¥ãƒ‡ãƒ¼ã‚¿
              const [pageData] = await client.runReport({
                property: `properties/${propertyId}`,
                dateRanges: [{ startDate: dateRange, endDate: dateRange }],
                dimensions: [{ name: 'pagePath' }],
                metrics: [{ name: 'screenPageViews' }],
                orderBys: [{ metric: { metricName: 'screenPageViews' }, desc: true }],
                limit: 10
              });
              
              // ãƒ‡ãƒã‚¤ã‚¹åˆ¥ãƒ‡ãƒ¼ã‚¿
              const [deviceData] = await client.runReport({
                property: `properties/${propertyId}`,
                dateRanges: [{ startDate: dateRange, endDate: dateRange }],
                dimensions: [{ name: 'deviceCategory' }],
                metrics: [
                  { name: 'activeUsers' },
                  { name: 'sessions' }
                ]
              });
              
              // çµæœã‚’ JSON å½¢å¼ã§å‡ºåŠ›
              const results = {
                date: dateRange,
                timestamp: new Date().toISOString(),
                basic_metrics: {},
                events: {},
                pages: {},
                devices: {}
              };
              
              // åŸºæœ¬ãƒ¡ãƒˆãƒªã‚¯ã‚¹
              if (basicMetrics.rows && basicMetrics.rows[0]) {
                const row = basicMetrics.rows[0];
                results.basic_metrics = {
                  active_users: parseInt(row.metricValues[0].value),
                  new_users: parseInt(row.metricValues[1].value),
                  sessions: parseInt(row.metricValues[2].value),
                  page_views: parseInt(row.metricValues[3].value),
                  bounce_rate: Math.round(parseFloat(row.metricValues[4].value) * 100) / 100,
                  avg_session_duration: Math.round(parseFloat(row.metricValues[5].value))
                };
              }
              
              // ã‚¤ãƒ™ãƒ³ãƒˆåˆ¥
              if (eventData.rows) {
                eventData.rows.forEach(row => {
                  const eventName = row.dimensionValues[0].value;
                  const eventCount = parseInt(row.metricValues[0].value);
                  results.events[eventName] = eventCount;
                });
              }
              
              // ãƒšãƒ¼ã‚¸åˆ¥
              if (pageData.rows) {
                pageData.rows.forEach(row => {
                  const pagePath = row.dimensionValues[0].value;
                  const pageViews = parseInt(row.metricValues[0].value);
                  results.pages[pagePath] = pageViews;
                });
              }
              
              // ãƒ‡ãƒã‚¤ã‚¹åˆ¥
              if (deviceData.rows) {
                deviceData.rows.forEach(row => {
                  const device = row.dimensionValues[0].value;
                  const users = parseInt(row.metricValues[0].value);
                  const sessions = parseInt(row.metricValues[1].value);
                  results.devices[device] = { users, sessions };
                });
              }
              
              // çµæœã‚’ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦å‡ºåŠ›ï¼ˆGitHub Actionsã§ä½¿ç”¨ï¼‰
              console.log('=== RESULTS START ===');
              console.log(JSON.stringify(results, null, 2));
              console.log('=== RESULTS END ===');
              
              // ã‚·ãƒ³ãƒ—ãƒ«ãªæ•°å€¤ã®ã¿å‡ºåŠ›
              console.log('=== SIMPLE NUMBERS ===');
              console.log('ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼:', results.basic_metrics.active_users);
              console.log('æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼:', results.basic_metrics.new_users);
              console.log('ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°:', results.basic_metrics.sessions);
              console.log('ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼:', results.basic_metrics.page_views);
              console.log('ç›´å¸°ç‡:', results.basic_metrics.bounce_rate + '%');
              console.log('å¹³å‡ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“:', results.basic_metrics.avg_session_duration + 'ç§’');
              
              console.log('\n=== TOP EVENTS ===');
              Object.entries(results.events).slice(0, 5).forEach(([event, count]) => {
                console.log(`${event}: ${count}`);
              });
              
              // ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
              require('fs').writeFileSync('ga4-numbers.json', JSON.stringify(results, null, 2));
              console.log('âœ… Data saved to ga4-numbers.json');
              
            } catch (error) {
              console.error('âŒ Error:', error.message);
              process.exit(1);
            }
          }
          
          extractNumbers();
          EOF
          
          node extract-ga4-numbers.js
        env:
          GOOGLE_ANALYTICS_PROPERTY_ID: ${{ secrets.GA_PROPERTY_ID }}
          GOOGLE_ANALYTICS_CREDENTIALS: ${{ secrets.GA_CREDENTIALS }}
          DATE_RANGE: ${{ github.event.inputs.date_range || 'yesterday' }}
          
      - name: Upload Numbers Data
        uses: actions/upload-artifact@v4
        with:
          name: ga4-numbers-data
          path: ga4-numbers.json
          
      - name: Create Numbers Report
        uses: google-gemini/gemini-cli-action@main
        env:
          GH_TOKEN: ${{ github.token }}
        with:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            ## GA4æ•°å€¤ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
            
            GA4ã‹ã‚‰å–å¾—ã—ãŸæ•°å€¤ãƒ‡ãƒ¼ã‚¿ã‚’åŸºã«ã€ã‚·ãƒ³ãƒ—ãƒ«ãªæ•°å€¤ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
            
            ### ãƒ‡ãƒ¼ã‚¿å–å¾—æƒ…å ±
            - **æ—¥ä»˜**: ${{ github.event.inputs.date_range || 'yesterday' }}
            - **å®Ÿè¡Œæ™‚åˆ»**: ${{ github.run_started_at }}
            
            ### ãƒ¬ãƒãƒ¼ãƒˆä½œæˆæŒ‡ç¤º
            
            ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§æ•°å€¤ã®ã¿ã®ã‚·ãƒ³ãƒ—ãƒ«ãªIssueã‚’ä½œæˆï¼š
            
            ```bash
            gh issue create \
              --title "ğŸ“Š GA4æ•°å€¤ãƒ‡ãƒ¼ã‚¿ - $(date '+%Y-%m-%d')" \
              --body "# ğŸ“Š GA4æ•°å€¤ãƒ‡ãƒ¼ã‚¿
            
            ## ğŸ“… ãƒ‡ãƒ¼ã‚¿æ¦‚è¦
            - **å¯¾è±¡æ—¥**: ${{ github.event.inputs.date_range || 'yesterday' }}
            - **å–å¾—æ™‚åˆ»**: ${{ github.run_started_at }}
            - **ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹**: Google Analytics 4
            
            ## ğŸ“ˆ åŸºæœ¬æŒ‡æ¨™ï¼ˆæ•°å€¤ã®ã¿ï¼‰
            
            \`\`\`
            ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼: [å®Ÿéš›ã®æ•°å€¤]
            æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼: [å®Ÿéš›ã®æ•°å€¤]  
            ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°: [å®Ÿéš›ã®æ•°å€¤]
            ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼: [å®Ÿéš›ã®æ•°å€¤]
            ç›´å¸°ç‡: [å®Ÿéš›ã®æ•°å€¤]%
            å¹³å‡ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“: [å®Ÿéš›ã®æ•°å€¤]ç§’
            \`\`\`
            
            ## ğŸ¯ ä¸»è¦ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆTOP5ï¼‰
            
            \`\`\`
            [ã‚¤ãƒ™ãƒ³ãƒˆå1]: [æ•°å€¤]
            [ã‚¤ãƒ™ãƒ³ãƒˆå2]: [æ•°å€¤]
            [ã‚¤ãƒ™ãƒ³ãƒˆå3]: [æ•°å€¤]
            [ã‚¤ãƒ™ãƒ³ãƒˆå4]: [æ•°å€¤]
            [ã‚¤ãƒ™ãƒ³ãƒˆå5]: [æ•°å€¤]
            \`\`\`
            
            ## ğŸ“± ãƒ‡ãƒã‚¤ã‚¹åˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼
            
            \`\`\`
            ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—: [ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°] ([ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°])
            ãƒ¢ãƒã‚¤ãƒ«: [ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°] ([ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°])
            ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ: [ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°] ([ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°])
            \`\`\`
            
            ## ğŸ“„ äººæ°—ãƒšãƒ¼ã‚¸ï¼ˆTOP5ï¼‰
            
            \`\`\`
            [ãƒšãƒ¼ã‚¸1]: [PVæ•°]
            [ãƒšãƒ¼ã‚¸2]: [PVæ•°]
            [ãƒšãƒ¼ã‚¸3]: [PVæ•°]
            [ãƒšãƒ¼ã‚¸4]: [PVæ•°]
            [ãƒšãƒ¼ã‚¸5]: [PVæ•°]
            \`\`\`
            
            ## ğŸ“Š JSON ãƒ‡ãƒ¼ã‚¿
            
            å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ãªå ´åˆã¯ã€ä»¥ä¸‹ã®Artifactsã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ï¼š
            - Workflow Run: ${{ github.run_id }}
            - Artifact: ga4-numbers-data
            
            ## ğŸ¤– ã‚³ãƒãƒ³ãƒ‰
            - \`@gemini numbers\` - æ•°å€¤ãƒ‡ãƒ¼ã‚¿å†å–å¾—
            - \`@gemini numbers 7days\` - 7æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿
            - \`@gemini numbers 30days\` - 30æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿
            
            ---
            
            *ãƒ‡ãƒ¼ã‚¿å–å¾—: ${{ github.run_started_at }}*"
            ```
            
            ### é‡è¦ãªæŒ‡ç¤º
            1. ä¸Šè¨˜ã® [å®Ÿéš›ã®æ•°å€¤] ã®éƒ¨åˆ†ã¯ã€å®Ÿéš›ã«GA4ã‹ã‚‰å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã§ç½®ãæ›ãˆã¦ãã ã•ã„
            2. æ•°å€¤ã®ã¿ã‚’ã‚¯ãƒªã‚¢ã«è¡¨ç¤ºã—ã¦ãã ã•ã„
            3. ä½™è¨ˆãªèª¬æ˜ã‚„è§£é‡ˆã¯ä¸è¦ã§ã™
            4. ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã‚‚ã€ãã®æ—¨ã‚’æ•°å€¤ã¨å…±ã«å ±å‘Šã—ã¦ãã ã•ã„
            
            ä»Šã™ãå®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

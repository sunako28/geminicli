# .github/workflows/gemini-comment-handler.yml
name: Gemini Comment Handler

on:
  workflow_dispatch:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  handle-gemini-comment:
    if: |
      github.event_name == 'workflow_dispatch' || 
      contains(github.event.comment.body, '@gemini')
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      issues: write
      pull-requests: write
      metadata: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Debug Information
        run: |
          echo "=== Event Information ==="
          echo "Event name: ${{ github.event_name }}"
          echo "Repository: ${{ github.repository }}"
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            echo "Issue number: ${{ github.event.issue.number }}"
            echo "Comment body: ${{ github.event.comment.body }}"
            echo "Comment user: ${{ github.event.comment.user.login }}"
          fi
          
      - name: Setup GitHub CLI
        run: |
          echo "Testing GitHub CLI authentication..."
          gh auth status
          echo "Listing recent issues..."
          gh issue list --limit 3
        env:
          GH_TOKEN: ${{ github.token }}
          
      - name: Direct Comment Test
        if: github.event_name == 'issue_comment'
        run: |
          echo "Posting direct comment to issue #${{ github.event.issue.number }}"
          gh issue comment ${{ github.event.issue.number }} --body "🤖 **直接投稿テスト**

          Geminiのワークフローが実行されました！

          **受信コメント:** ${{ github.event.comment.body }}
          **投稿者:** @${{ github.event.comment.user.login }}
          **実行時刻:** $(date)

          この返信が表示されていれば、GitHub CLI経由のコメント投稿が正常に動作しています。

          次はGemini経由のコメント投稿をテストします..."
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Process with Gemini
        uses: google-gemini/gemini-cli-action@main
        env:
          GH_TOKEN: ${{ github.token }}
        with:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            ## Gemini経由コメント投稿テスト
            
            実行情報:
            - イベント: ${{ github.event_name }}
            - 実行時刻: ${{ github.run_started_at }}
            - Issue番号: ${{ github.event.issue.number }}
            
            ユーザーコメント: "${{ github.event.comment.body }}"
            投稿者: ${{ github.event.comment.user.login }}
            
            ## 実行指示
            以下のコマンドを実行して、Issue #${{ github.event.issue.number }} にコメントを投稿してください:
            
            ```bash
            gh issue comment ${{ github.event.issue.number }} --body "🎉 **Gemini経由の返信成功！**
            
            コメント反応機能が正常に動作しています。
            
            **あなたのコメント:**
            > ${{ github.event.comment.body }}
            
            **処理結果:**
            - ✅ コメント検知: 成功
            - ✅ ワークフロー実行: 成功
            - ✅ Gemini処理: 成功
            - ✅ 返信投稿: 成功
            
            **利用可能なコマンド:**
            - \`@gemini このプロジェクトを分析して\`
            - \`@gemini 改善提案をして\`
            - \`@gemini 質問に答えて\`
            
            何でもお気軽にお声がけください！"
            ```
            
            このコマンドを今すぐ実行してください。

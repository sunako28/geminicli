# .github/workflows/ga4-web-analysis-fixed.yml
name: GA4 Web Analysis (Fixed)

on:
  workflow_dispatch:
    inputs:
      analysis_type:
        description: 'åˆ†æã‚¿ã‚¤ãƒ—'
        required: false
        default: 'daily'
        type: choice
        options:
        - 'daily'
        - 'weekly'
        - 'monthly'
        - 'custom'
  schedule:
    # æ¯æ—¥åˆå‰10æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 1 * * *'
  issue_comment:
    types: [created]

jobs:
  ga4-analysis:
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@gemini analytics'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # â† Node.js 20ã«å¤‰æ›´
          
      - name: Verify Node.js Version
        run: |
          echo "Node.js version: $(node --version)"
          echo "npm version: $(npm --version)"
          
      - name: Install Google Analytics Dependencies
        run: |
          npm install @google-analytics/data@^4.0.0
          npm install googleapis@^128.0.0
          
      - name: GA4 MCP Web Analysis
        uses: google-gemini/gemini-cli-action@main
        env:
          GH_TOKEN: ${{ github.token }}
          GOOGLE_ANALYTICS_PROPERTY_ID: ${{ secrets.GA_PROPERTY_ID }}
          GOOGLE_ANALYTICS_CREDENTIALS: ${{ secrets.GA_CREDENTIALS }}
        with:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          settings_json: |
            {
              "mcps": [
                {
                  "name": "google-analytics",
                  "command": "node",
                  "args": ["mcp-analytics-server.js"],
                  "env": {
                    "GOOGLE_ANALYTICS_PROPERTY_ID": "${{ secrets.GA_PROPERTY_ID }}",
                    "GOOGLE_ANALYTICS_CREDENTIALS": "${{ secrets.GA_CREDENTIALS }}"
                  }
                }
              ]
            }
          prompt: |
            Google Analytics MCPã‚’ä½¿ç”¨ã—ã¦Webã‚µã‚¤ãƒˆã®åˆ†æã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
            
            ## å®Ÿè¡Œæƒ…å ±
            - **Node.js ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 20
            - **å®Ÿè¡Œã‚¿ã‚¤ãƒ—**: ${{ github.event_name }}
            - **åˆ†æã‚¿ã‚¤ãƒ—**: ${{ github.event.inputs.analysis_type || 'daily' }}
            - **å®Ÿè¡Œæ™‚åˆ»**: ${{ github.run_started_at }}
            
            ## åˆ†ææ‰‹é †
            
            ### Step 1: ç’°å¢ƒç¢ºèª
            ã¾ãšã€Google Analytics MCP ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ï¼š
            
            ```javascript
            // åŸºæœ¬çš„ãªæ¥ç¶šãƒ†ã‚¹ãƒˆ
            console.log('GA4 MCP Server starting...');
            console.log('Property ID:', process.env.GOOGLE_ANALYTICS_PROPERTY_ID);
            ```
            
            ### Step 2: åŸºæœ¬ãƒ‡ãƒ¼ã‚¿å–å¾—
            ä»¥ä¸‹ã®åŸºæœ¬ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å–å¾—ï¼š
            
            ```javascript
            // æ˜¨æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const pageViews = await getPageViews('yesterday', 'yesterday');
            const activeUsers = await getActiveUsers('yesterday', 'yesterday');
            const userBehavior = await getUserBehavior('yesterday', 'yesterday');
            ```
            
            ### Step 3: è©³ç´°åˆ†æï¼ˆå¯èƒ½ãªç¯„å›²ã§ï¼‰
            ```javascript
            // ãƒ‡ãƒã‚¤ã‚¹åˆ¥åˆ†æ
            const deviceAnalysis = await getDeviceAnalysis('yesterday', 'yesterday');
            
            // æµå…¥çµŒè·¯åˆ†æ
            const trafficSources = await getTrafficSources('yesterday', 'yesterday');
            ```
            
            ## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
            
            MCPã‚µãƒ¼ãƒãƒ¼ãŒåˆ©ç”¨ã§ããªã„å ´åˆã¯ã€ä»¥ä¸‹ã®ä»£æ›¿å‡¦ç†ã‚’å®Ÿè¡Œï¼š
            
            1. **MCPæ¥ç¶šã‚¨ãƒ©ãƒ¼ã®å ´åˆ**
               - åŸºæœ¬çš„ãªåˆ†æãƒ¬ãƒãƒ¼ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆ
               - è¨­å®šã®ç¢ºèªæ‰‹é †ã‚’æç¤º
               - æ¬¡å›å®Ÿè¡Œã§ã®æ”¹å–„ã‚’ææ¡ˆ
            
            2. **èªè¨¼ã‚¨ãƒ©ãƒ¼ã®å ´åˆ**  
               - èªè¨¼è¨­å®šã®ç¢ºèªæ‰‹é †ã‚’æç¤º
               - å¿…è¦ãªSecretsè¨­å®šã‚’èª¬æ˜
               - ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰ã‚’æä¾›
            
            ## Issueä½œæˆæŒ‡ç¤º
            
            åˆ†æãŒæˆåŠŸã—ãŸå ´åˆã€ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€ã„ãšã‚Œã‚‚ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§Issueã‚’ä½œæˆï¼š
            
            **ã‚¿ã‚¤ãƒˆãƒ«**: ğŸ“Š GA4åˆ†æãƒ¬ãƒãƒ¼ãƒˆ (${{ github.run_started_at }})
            
            **å†…å®¹**:
            ```markdown
            # ğŸ“Š GA4åˆ†æãƒ¬ãƒãƒ¼ãƒˆ
            
            ## ğŸ”§ å®Ÿè¡Œç’°å¢ƒ
            - **Node.js**: 20.x
            - **å®Ÿè¡Œæ™‚åˆ»**: ${{ github.run_started_at }}
            - **ãƒˆãƒªã‚¬ãƒ¼**: ${{ github.event_name }}
            
            ## ğŸ“ˆ åˆ†æçµæœ
            
            ### âœ… æˆåŠŸã—ãŸå‡¦ç†
            [å®Ÿè¡Œã§ããŸåˆ†æé …ç›®]
            
            ### âŒ å¤±æ•—ã—ãŸå‡¦ç†
            [ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸé …ç›®ã¨ãã®ç†ç”±]
            
            ### ğŸ“Š å–å¾—ãƒ‡ãƒ¼ã‚¿ï¼ˆå¯èƒ½ãªç¯„å›²ï¼‰
            [å–å¾—ã§ããŸãƒ‡ãƒ¼ã‚¿ã®è¦ç´„]
            
            ## ğŸ”§ æ”¹å–„äº‹é …
            
            ### ä»Šã™ãä¿®æ­£ãŒå¿…è¦
            - [ç·Šæ€¥ä¿®æ­£é …ç›®]
            
            ### æ¬¡å›ã¾ã§ã«å¯¾å¿œ
            - [ç¶™ç¶šçš„æ”¹å–„é …ç›®]
            
            ## ğŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
            - [ ] [å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³1]
            - [ ] [å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³2]
            
            ## ğŸ¤– è¿½åŠ åˆ†æã®ä¾é ¼æ–¹æ³•
            - `@gemini analytics è©³ç´°` - è©³ç´°åˆ†æ
            - `@gemini analytics debug` - ãƒ‡ãƒãƒƒã‚°å®Ÿè¡Œ
            - `@gemini analytics setup` - è¨­å®šç¢ºèª
            ```
            
            ## å®Ÿè¡Œé–‹å§‹
            ä¸Šè¨˜ã®æ‰‹é †ã«å¾“ã£ã¦ã€GA4åˆ†æã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã‚‚ã€é©åˆ‡ãªãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

name: GA4 Simple PageViews
on:
  workflow_dispatch:
    inputs:
      date_range:
        description: '分析期間'
        required: false
        default: 'yesterday'
        type: choice
        options:
        - 'yesterday'
        - '7daysAgo'
        - '30daysAgo'
  schedule:
    - cron: '0 1 * * *'  # 毎日日本時間10時（UTC 1時）
  issue_comment:
    types: [created]

jobs:
  ga4-simple-pageviews:
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@gemini pv'))
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      issues: write
      id-token: write
    
    steps:
      - name: Setup Python for MCP
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install pipx
        run: |
          python -m pip install --user pipx
          python -m pipx ensurepath
          
      - name: GA4 Simple PageViews Analysis
        uses: google-gemini/gemini-cli-action@main
        env:
          GH_TOKEN: ${{ github.token }}
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.GA_CREDENTIALS }}
        with:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          settings_json: |
            {
              "mcpServers": {
                "analytics-mcp": {
                  "command": "pipx",
                  "args": [
                    "run",
                    "--spec",
                    "git+https://github.com/googleanalytics/google-analytics-mcp.git",
                    "google-analytics-mcp"
                  ],
                  "env": {
                    "GOOGLE_APPLICATION_CREDENTIALS_JSON": "$GOOGLE_APPLICATION_CREDENTIALS_JSON",
                    "GA_PROPERTY_ID": "${{ secrets.GA_PROPERTY_ID }}"
                  }
                }
              },
              "coreTools": [
                "mcp__analytics-mcp__run_report",
                "mcp__analytics-mcp__get_property_details",
                "mcp__analytics-mcp__get_account_summaries"
              ]
            }
          prompt: |
            GA4からページビュー数のみ取得して簡単なレポートを作成してください。

            ## 🎯 シンプルな任務

            **ページビュー数の取得のみ** 行ってください：

            1. **まず利用可能なツールを確認:**
               ```
               what MCP tools are available from analytics-mcp server?
               ```

            2. **基本のページビュー数を取得:**
               ```
               use mcp__analytics-mcp__run_report to get total page views for property ${{ secrets.GA_PROPERTY_ID }} for date range ${{ github.event.inputs.date_range || 'yesterday' }}
               ```

            2. **Issue作成:**
               
               データ取得後、以下のコマンドを**必ず実行**してください：

               ```
               gh issue create --title "📊 GA4ページビュー数 - $(date '+%Y-%m-%d')" --body "# 📊 GA4ページビュー数

            ## 📅 基本情報
            - **対象日**: ${{ github.event.inputs.date_range || 'yesterday' }}
            - **取得時刻**: $(date '+%Y-%m-%d %H:%M JST')
            - **プロパティID**: ${{ secrets.GA_PROPERTY_ID }}

            ## 📈 ページビュー数

            **総ページビュー**: [実際の数値] PV

            ## 💡 ひとこと分析

            [数値に基づいた簡単なコメント]

            ## 🤖 次回取得
            - \`@gemini pv\` - ページビュー数再取得
            - 明日10時に自動実行

            ---
            **📊 データ**: GA4公式MCP  
            **🕐 更新**: $(date '+%H:%M JST')"
               ```

            ## ⚡ 重要な指示

            1. **ページビュー数のみ取得** - 他の複雑なデータは不要
            2. **[実際の数値]を実際のページビュー数で置換**
            3. **エラーが出たら「データ取得できませんでした」と記載**
            4. **必ず gh issue create コマンドを実行**
            5. **シンプルで短いレポートにする**

            今すぐページビュー数を取得してIssueを作成してください！

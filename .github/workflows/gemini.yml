name: GA4 Simple PageViews
on:
  workflow_dispatch:
    inputs:
      date_range:
        description: 'åˆ†ææœŸé–“'
        required: false
        default: 'yesterday'
        type: choice
        options:
        - 'yesterday'
        - '7daysAgo'
        - '30daysAgo'
  schedule:
    - cron: '0 1 * * *'  # æ¯æ—¥æ—¥æœ¬æ™‚é–“10æ™‚ï¼ˆUTC 1æ™‚ï¼‰
  issue_comment:
    types: [created]

jobs:
  ga4-simple-pageviews:
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@gemini pv'))
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      issues: write
      id-token: write
    
    steps:
      - name: Setup Python for MCP
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install pipx
        run: |
          python -m pip install --user pipx
          python -m pipx ensurepath
          
      - name: GA4 Simple PageViews Analysis
        uses: google-gemini/gemini-cli-action@main
        env:
          GH_TOKEN: ${{ github.token }}
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.GA_CREDENTIALS }}
        with:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          settings_json: |
            {
              "mcpServers": {
                "analytics-mcp": {
                  "command": "pipx",
                  "args": [
                    "run",
                    "--spec",
                    "git+https://github.com/googleanalytics/google-analytics-mcp.git",
                    "google-analytics-mcp"
                  ],
                  "env": {
                    "GOOGLE_APPLICATION_CREDENTIALS_JSON": "$GOOGLE_APPLICATION_CREDENTIALS_JSON",
                    "GA_PROPERTY_ID": "${{ secrets.GA_PROPERTY_ID }}"
                  }
                }
              },
              "coreTools": [
                "mcp__analytics-mcp__run_report",
                "mcp__analytics-mcp__get_property_details",
                "mcp__analytics-mcp__get_account_summaries"
              ]
            }
          prompt: |
            GA4ã‹ã‚‰ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼æ•°ã®ã¿å–å¾—ã—ã¦ç°¡å˜ãªãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

            ## ğŸ¯ ã‚·ãƒ³ãƒ—ãƒ«ãªä»»å‹™

            **ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼æ•°ã®å–å¾—ã®ã¿** è¡Œã£ã¦ãã ã•ã„ï¼š

            1. **ã¾ãšåˆ©ç”¨å¯èƒ½ãªãƒ„ãƒ¼ãƒ«ã‚’ç¢ºèª:**
               ```
               what MCP tools are available from analytics-mcp server?
               ```

            2. **åŸºæœ¬ã®ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼æ•°ã‚’å–å¾—:**
               ```
               use mcp__analytics-mcp__run_report to get total page views for property ${{ secrets.GA_PROPERTY_ID }} for date range ${{ github.event.inputs.date_range || 'yesterday' }}
               ```

            2. **Issueä½œæˆ:**
               
               ãƒ‡ãƒ¼ã‚¿å–å¾—å¾Œã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’**å¿…ãšå®Ÿè¡Œ**ã—ã¦ãã ã•ã„ï¼š

               ```
               gh issue create --title "ğŸ“Š GA4ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼æ•° - $(date '+%Y-%m-%d')" --body "# ğŸ“Š GA4ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼æ•°

            ## ğŸ“… åŸºæœ¬æƒ…å ±
            - **å¯¾è±¡æ—¥**: ${{ github.event.inputs.date_range || 'yesterday' }}
            - **å–å¾—æ™‚åˆ»**: $(date '+%Y-%m-%d %H:%M JST')
            - **ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ID**: ${{ secrets.GA_PROPERTY_ID }}

            ## ğŸ“ˆ ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼æ•°

            **ç·ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼**: [å®Ÿéš›ã®æ•°å€¤] PV

            ## ğŸ’¡ ã²ã¨ã“ã¨åˆ†æ

            [æ•°å€¤ã«åŸºã¥ã„ãŸç°¡å˜ãªã‚³ãƒ¡ãƒ³ãƒˆ]

            ## ğŸ¤– æ¬¡å›å–å¾—
            - \`@gemini pv\` - ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼æ•°å†å–å¾—
            - æ˜æ—¥10æ™‚ã«è‡ªå‹•å®Ÿè¡Œ

            ---
            **ğŸ“Š ãƒ‡ãƒ¼ã‚¿**: GA4å…¬å¼MCP  
            **ğŸ• æ›´æ–°**: $(date '+%H:%M JST')"
               ```

            ## âš¡ é‡è¦ãªæŒ‡ç¤º

            1. **ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼æ•°ã®ã¿å–å¾—** - ä»–ã®è¤‡é›‘ãªãƒ‡ãƒ¼ã‚¿ã¯ä¸è¦
            2. **[å®Ÿéš›ã®æ•°å€¤]ã‚’å®Ÿéš›ã®ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼æ•°ã§ç½®æ›**
            3. **ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã‚‰ã€Œãƒ‡ãƒ¼ã‚¿å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€ã¨è¨˜è¼‰**
            4. **å¿…ãš gh issue create ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ**
            5. **ã‚·ãƒ³ãƒ—ãƒ«ã§çŸ­ã„ãƒ¬ãƒãƒ¼ãƒˆã«ã™ã‚‹**

            ä»Šã™ããƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼æ•°ã‚’å–å¾—ã—ã¦Issueã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼

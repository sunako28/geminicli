name: Gemini GA4 Summary (npx server)

on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 23 * * *'  # 毎日 08:00 JST

jobs:
  summarize-ga4:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Run Gemini GA4 Summary
        uses: google-gemini/gemini-cli-action@main
        env:
          GOOGLE_CLIENT_EMAIL: ${{ secrets.GOOGLE_CLIENT_EMAIL }}
          # ↓ 改行入りの秘密鍵は \n を実改行に戻してから渡す（後述の代替案もOK）
          GOOGLE_PRIVATE_KEY: ${{ secrets.GOOGLE_PRIVATE_KEY }}
          GA_PROPERTY_ID: ${{ secrets.GA_PROPERTY_ID }}
        with:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          settings_json: |
            {
              "mcpServers": {
                "google-analytics": {
                  "command": "npx",
                  "args": ["-y", "mcp-server-google-analytics"],
                  "env": {
                    "GOOGLE_CLIENT_EMAIL": "$GOOGLE_CLIENT_EMAIL",
                    "GOOGLE_PRIVATE_KEY": "$GOOGLE_PRIVATE_KEY",
                    "GA_PROPERTY_ID": "$GA_PROPERTY_ID"
                  }
                }
              },
              "coreTools": [
                "mcp__google-analytics__run_report"
              ]
            }
          prompt: |
            あなたはGA4の要約アシスタントです。
            環境変数 GA_PROPERTY_ID で指定されたプロパティについて、プロパティのタイムゾーン（JST想定）で「昨日」のデータを取得し要約してください。
            - 主なトラフィックソース（source/medium）
            - 人気ページ（pagePath等）
            - 主なコンバージョンイベント
            必要に応じて mcp__google-analytics__run_report を複数回呼び、短い段落＋箇条書きでまとめてください。
